#
# UefiTcgPlatform.py
#
# Copyright (C) 2015 - 2017 efipy.core@gmail.com All rights reserved.
#
# UefiTcgPlatform.py is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# EfiPy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

from EfiPy.MdePkg.IndustryStandard          import *
from EfiPy.MdePkg.Protocol.DevicePathEfiPy  import EFI_DEVICE_PATH_PROTOCOL
from EfiPy.MdePkg.Uefi.UefiSpec             import EFI_CONFIGURATION_TABLE
from EfiPy.MdePkg.Uefi                      import UefiGpt

# import Tpm12
from EfiPy.MdePkg.IndustryStandard.Tpm20 import TPML_DIGEST_VALUES
# import Uefi

TCG_EVENTTYPE = UINT32

EV_POST_CODE                = TCG_EVENTTYPE (0x00000001).value
EV_NO_ACTION                = TCG_EVENTTYPE (0x00000003).value
EV_SEPARATOR                = TCG_EVENTTYPE (0x00000004).value
EV_S_CRTM_CONTENTS          = TCG_EVENTTYPE (0x00000007).value
EV_S_CRTM_VERSION           = TCG_EVENTTYPE (0x00000008).value
EV_CPU_MICROCODE            = TCG_EVENTTYPE (0x00000009).value
EV_TABLE_OF_DEVICES         = TCG_EVENTTYPE (0x0000000B).value

EV_EFI_EVENT_BASE                   = TCG_EVENTTYPE (0x80000000).value
EV_EFI_VARIABLE_DRIVER_CONFIG       = (EV_EFI_EVENT_BASE + 1)
EV_EFI_VARIABLE_BOOT                = (EV_EFI_EVENT_BASE + 2)
EV_EFI_BOOT_SERVICES_APPLICATION    = (EV_EFI_EVENT_BASE + 3)
EV_EFI_BOOT_SERVICES_DRIVER         = (EV_EFI_EVENT_BASE + 4)
EV_EFI_RUNTIME_SERVICES_DRIVER      = (EV_EFI_EVENT_BASE + 5)
EV_EFI_GPT_EVENT                    = (EV_EFI_EVENT_BASE + 6)
EV_EFI_ACTION                       = (EV_EFI_EVENT_BASE + 7)
EV_EFI_PLATFORM_FIRMWARE_BLOB       = (EV_EFI_EVENT_BASE + 8)
EV_EFI_HANDOFF_TABLES               = (EV_EFI_EVENT_BASE + 9)
EV_EFI_VARIABLE_AUTHORITY           = (EV_EFI_EVENT_BASE + 0xE0)

EFI_CALLING_EFI_APPLICATION         = \
   "Calling EFI Application from Boot Option"
EFI_RETURNING_FROM_EFI_APPLICATOIN  = \
   "Returning from EFI Application from Boot Option"
EFI_EXIT_BOOT_SERVICES_INVOCATION   = \
   "Exit Boot Services Invocation"
EFI_EXIT_BOOT_SERVICES_FAILED       = \
   "Exit Boot Services Returned with Failure"
EFI_EXIT_BOOT_SERVICES_SUCCEEDED    = \
   "Exit Boot Services Returned with Success"

EV_POSTCODE_INFO_POST_CODE    = "POST CODE"
POST_CODE_STR_LEN             = len (EV_POSTCODE_INFO_POST_CODE)

EV_POSTCODE_INFO_SMM_CODE     = "SMM CODE"
SMM_CODE_STR_LEN             = len (EV_POSTCODE_INFO_SMM_CODE)

EV_POSTCODE_INFO_ACPI_DATA    = "ACPI DATA"
ACPI_DATA_LEN                 = len (EV_POSTCODE_INFO_ACPI_DATA)

EV_POSTCODE_INFO_BIS_CODE     = "BIS CODE"
BIS_CODE_LEN                  = len (EV_POSTCODE_INFO_BIS_CODE)

EV_POSTCODE_INFO_UEFI_PI      = "UEFI PI"
UEFI_PI_LEN                   = len (EV_POSTCODE_INFO_UEFI_PI)

EV_POSTCODE_INFO_OPROM        = "Embedded Option ROM"
OPROM_LEN                     = len (EV_POSTCODE_INFO_OPROM)

FIRMWARE_DEBUGGER_EVENT_STRING      = "UEFI Debug Mode"
FIRMWARE_DEBUGGER_EVENT_STRING_LEN  = len(FIRMWARE_DEBUGGER_EVENT_STRING) - 1
TCG_PCRINDEX  = Tpm12.TPM_PCRINDEX
TCG_DIGEST    = Tpm12.TPM_DIGEST

class TCG_PCR_EVENT (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("PCRIndex",  TCG_PCRINDEX),
    ("EventType", TCG_EVENTTYPE),
    ("Digest",    TCG_DIGEST),
    ("EventSize", UINT32),
    ("Event",     UINT8 * 1)
  ]

TSS_EVENT_DATA_MAX_SIZE   = 256

class TCG_PCR_EVENT_HDR (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("PCRIndex",  TCG_PCRINDEX),
    ("EventType", TCG_EVENTTYPE),
    ("Digest",    TCG_DIGEST),
    ("EventSize", UINT32),
  ]

class EFI_PLATFORM_FIRMWARE_BLOB (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("BlobBase",    EFI_PHYSICAL_ADDRESS),
    ("BlobLength",  UINT64)
  ]

class EFI_IMAGE_LOAD_EVENT (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("ImageLocationInMemory", EFI_PHYSICAL_ADDRESS),
    ("ImageLengthInMemory",   UINTN),
    ("ImageLinkTimeAddress",  UINTN),
    ("LengthOfDevicePath",    UINTN),
    ("DevicePath",            EFI_DEVICE_PATH_PROTOCOL * 1)
  ]

class EFI_HANDOFF_TABLE_POINTERS (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("NumberOfTables",  UINTN),
    ("TableEntry",      EFI_CONFIGURATION_TABLE * 1)
  ]

class EFI_VARIABLE_DATA (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("VariableName",        EFI_GUID),
    ("UnicodeNameLength",   UINTN),
    ("VariableDataLength",  UINTN),
    ("UnicodeName",         CHAR16 * 1),
    ("VariableData",        INT8 * 1)
  ]

class UEFI_VARIABLE_DATA (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
  ("VariableName",        EFI_GUID),
  ("UnicodeNameLength",   UINT64),
  ("VariableDataLength",  UINT64),
  ("UnicodeName",         CHAR16 * 1),
  ("VariableData",        INT8 * 1),
  ]

class EFI_VARIABLE_DATA_TREE (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
  ("VariableName",        EFI_GUID),
  ("UnicodeNameLength",   UINT64),
  ("VariableDataLength",  UINT64),
  ("UnicodeName",         CHAR16 * 1),
  ("VariableData",        INT8 * 1),
  ]

class EFI_GPT_DATA (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("EfiPartitionHeader",  UefiGpt.EFI_PARTITION_TABLE_HEADER),
    ("NumberOfPartitions",  UINTN),
    ("Partitions",          UefiGpt.EFI_PARTITION_ENTRY * 1)
  ]

class TCG_PCR_EVENT2 (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
  ("PCRIndex",  TCG_PCRINDEX),
  ("EventType", TCG_EVENTTYPE),
  ("Digest",    TPML_DIGEST_VALUES),
  ("EventSize", UINT32),
  ("Event",     UINT8 * 1),
  ]

class TCG_PCR_EVENT2_HDR (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
  ("PCRIndex",  TCG_PCRINDEX),
  ("EventType", TCG_EVENTTYPE),
  ("Digests",   TPML_DIGEST_VALUES),
  ("EventSize", UINT32),
  ]

class TCG_EfiSpecIdEventAlgorithmSize (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
  ("algorithmId", UINT16),
  ("digestSize",  UINT16),
  ]

TCG_EfiSpecIDEventStruct_SIGNATURE_02 = "Spec ID Event02"
TCG_EfiSpecIDEventStruct_SIGNATURE_03 = "Spec ID Event03"

TCG_EfiSpecIDEventStruct_SPEC_VERSION_MAJOR_TPM12   = 1
TCG_EfiSpecIDEventStruct_SPEC_VERSION_MINOR_TPM12   = 2
TCG_EfiSpecIDEventStruct_SPEC_ERRATA_TPM12          = 2

TCG_EfiSpecIDEventStruct_SPEC_VERSION_MAJOR_TPM2   = 2
TCG_EfiSpecIDEventStruct_SPEC_VERSION_MINOR_TPM2   = 0
TCG_EfiSpecIDEventStruct_SPEC_ERRATA_TPM2          = 0

class TCG_EfiSpecIDEventStruct (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("signature",             UINT8 * 16),
    ("platformClass",         UINT32),
    ("specVersionMinor",      UINT8),
    ("specVersionMajor",      UINT8),
    ("specErrata",            UINT8),
    ("uintnSize",             UINT8),
    # ("numberOfAlgorithms",  UINT32),
    # ("digestSize",          TCG_EfiSpecIdEventAlgorithmSize * numberOfAlgorithms),
    # ("vendorInfoSize",      UINT8),
    # ("vendorInfo",          UINT8 * vendorInfoSize),
  ]

TCG_EfiStartupLocalityEvent_SIGNATURE      = "StartupLocality"
LOCALITY_0_INDICATOR        = 0x01
LOCALITY_1_INDICATOR        = 0x02
LOCALITY_2_INDICATOR        = 0x03
LOCALITY_3_INDICATOR        = 0x04
LOCALITY_4_INDICATOR        = 0x05

class TCG_EfiSpecIDEventStruct (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("signature",       UINT8 * 16),
    ("StartupLocality", UINT8),
  ]

