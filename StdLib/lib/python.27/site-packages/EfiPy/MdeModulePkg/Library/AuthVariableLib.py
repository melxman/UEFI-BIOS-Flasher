# AuthVariableLib.py
#
# Copyright (C) 2017 efipy.core@gmail.com All rights reserved.
#
# AuthVariableLib.py is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# EfiPy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

from EfiPy  import *

from EfiPy.MdeModulePkg.Protocol.VarCheck import VARIABLE_ENTRY_PROPERTY

class AUTH_VARIABLE_INFO (Structure):
  _fields_ = [
  ("VariableName",    POINTER(CHAR16)),
  ("VendorGuid",      POINTER(EFI_GUID)),
  ("Attributes",      UINT32),
  ("DataSize",        UINTN),
  ("Data",            PVOID),
  ("PubKeyIndex",     UINT32),
  ("MonotonicCount",  UINT64),
  ("TimeStamp",       POINTER(EFI_TIME)),
  ]

AUTH_VAR_LIB_FIND_VARIABLE = CFUNCTYPE (
  EFI_STATUS,
  POINTER(CHAR16),              # IN  *VariableName,
  POINTER(EFI_GUID),            # IN  *VendorGuid,
  POINTER(AUTH_VARIABLE_INFO)   # OUT *AuthVariableInfo
  )

AUTH_VAR_LIB_FIND_NEXT_VARIABLE = CFUNCTYPE (
  EFI_STATUS,
  POINTER(CHAR16),              # IN  *VariableName,
  POINTER(EFI_GUID),            # IN  *VendorGuid,
  POINTER(AUTH_VARIABLE_INFO)   # OUT *AuthVariableInfo
  )

AUTH_VAR_LIB_UPDATE_VARIABLE = CFUNCTYPE (
  EFI_STATUS,
  POINTER(AUTH_VARIABLE_INFO)   # IN *AuthVariableInfo
  )

AUTH_VAR_LIB_GET_SCRATCH_BUFFER = CFUNCTYPE (
  EFI_STATUS,
  POINTER(UINTN),   # IN OUT  *ScratchBufferSize
  POINTER(PVOID)    # OUT     **ScratchBuffer
  )

AUTH_VAR_LIB_CHECK_REMAINING_SPACE = CFUNCTYPE (
  BOOLEAN,
  UINT32,   # IN UINT32
  )

AUTH_VAR_LIB_AT_RUNTIME = CFUNCTYPE (
  BOOLEAN
  )

class AUTH_VAR_LIB_CONTEXT_IN (Structure):
  _fields_ = [
  ("StructVersion",                     UINTN),
  ("StructSize",                        UINTN),
  ("MaxAuthVariableSize",               UINTN),
  ("FindVariable",                      AUTH_VAR_LIB_FIND_VARIABLE),
  ("FindNextVariable",                  AUTH_VAR_LIB_FIND_NEXT_VARIABLE),
  ("UpdateVariable",                    AUTH_VAR_LIB_UPDATE_VARIABLE),
  ("GetScratchBuffer",                  AUTH_VAR_LIB_GET_SCRATCH_BUFFER),
  ("CheckRemainingSpaceForConsistency", AUTH_VAR_LIB_CHECK_REMAINING_SPACE),
  ("AtRuntime",                         AUTH_VAR_LIB_AT_RUNTIME),
  ]

AUTH_VAR_LIB_CONTEXT_OUT_STRUCT_VERSION = 0x01

class AUTH_VAR_LIB_CONTEXT_OUT (Structure):
  _fields_ = [
  ("StructVersion",         UINTN),
  ("StructSize",            UINTN),
  ("AuthVarEntry",          POINTER(VARIABLE_ENTRY_PROPERTY)),
  ("AuthVarEntryCount",     UINTN),
  ("AddressPointer",        POINTER(POINTER(PVOID))),
  ("AddressPointerCount",   UINTN),
  ]

