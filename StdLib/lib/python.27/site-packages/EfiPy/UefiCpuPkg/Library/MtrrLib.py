# MtrrLib.py
#
# Copyright (C) 2017 efipy.core@gmail.com All rights reserved.
#
# MtrrLib.py is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# EfiPy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

from EfiPy import *

MTRR_NUMBER_OF_VARIABLE_MTRR  = 32

RESERVED_FIRMWARE_VARIABLE_MTRR_NUMBER  = 2

MTRR_NUMBER_OF_FIXED_MTRR      = 11

FIRMWARE_VARIABLE_MTRR_NUMBER  = 6
MTRR_LIB_IA32_MTRR_CAP                      = 0x0FE
MTRR_LIB_IA32_MTRR_CAP_VCNT_MASK            = 0x0FF
MTRR_LIB_IA32_MTRR_FIX64K_00000             = 0x250
MTRR_LIB_IA32_MTRR_FIX16K_80000             = 0x258
MTRR_LIB_IA32_MTRR_FIX16K_A0000             = 0x259
MTRR_LIB_IA32_MTRR_FIX4K_C0000              = 0x268
MTRR_LIB_IA32_MTRR_FIX4K_C8000              = 0x269
MTRR_LIB_IA32_MTRR_FIX4K_D0000              = 0x26A
MTRR_LIB_IA32_MTRR_FIX4K_D8000              = 0x26B
MTRR_LIB_IA32_MTRR_FIX4K_E0000              = 0x26C
MTRR_LIB_IA32_MTRR_FIX4K_E8000              = 0x26D
MTRR_LIB_IA32_MTRR_FIX4K_F0000              = 0x26E
MTRR_LIB_IA32_MTRR_FIX4K_F8000              = 0x26F
MTRR_LIB_IA32_VARIABLE_MTRR_BASE            = 0x200

MTRR_LIB_IA32_VARIABLE_MTRR_END             = 0x20F
MTRR_LIB_IA32_MTRR_DEF_TYPE                 = 0x2FF
MTRR_LIB_MSR_VALID_MASK                     = 0xFFFFFFFFFL
MTRR_LIB_CACHE_VALID_ADDRESS                = 0xFFFFFF000L
MTRR_LIB_CACHE_MTRR_ENABLED                 = 0x800
MTRR_LIB_CACHE_FIXED_MTRR_ENABLED           = 0x400

class FIXED_MTRR (Structure):
  _fields_ = [
    ("Msr",         UINT32),
    ("BaseAddress", UINT32),
    ("Length",      UINT32),
    ]

class VARIABLE_MTRR (Structure):
  _fields_ = [
    ("BaseAddress", UINT64),
    ("Length",      UINT64),
    ("Type",        UINT64),
    ("Msr",         UINT64),
    ("Valid",       BOOLEAN),
    ("Used",        BOOLEAN),
    ]

class MTRR_VARIABLE_SETTING (Structure):
  _fields_ = [
    ("Base",  UINT64),
    ("Mask",  UINT64),
    ]

class MTRR_VARIABLE_SETTINGS (Structure):
  _fields_ = [
    ("Mtrr",  MTRR_VARIABLE_SETTING * MTRR_NUMBER_OF_VARIABLE_MTRR),
    ]

class MTRR_FIXED_SETTINGS (Structure):
  _fields_ = [
    ("Mtrr",  UINT64 * MTRR_NUMBER_OF_FIXED_MTRR),
    ]

class MTRR_SETTINGS (Structure):
  _fields_ = [
    ("Fixed",         MTRR_FIXED_SETTINGS),
    ("Variables",     MTRR_VARIABLE_SETTINGS),
    ("MtrrDefType",   UINT64),
    ]

CacheUncacheable    = 0
CacheWriteCombining = 1
CacheWriteThrough   = 4
CacheWriteProtected = 5
CacheWriteBack      = 6
CacheInvalid        = 7
MTRR_MEMORY_CACHE_TYPE = UINTN

MTRR_CACHE_UNCACHEABLE      = 0
MTRR_CACHE_WRITE_COMBINING  = 1
MTRR_CACHE_WRITE_THROUGH    = 4
MTRR_CACHE_WRITE_PROTECTED  = 5
MTRR_CACHE_WRITE_BACK       = 6
MTRR_CACHE_INVALID_TYPE     = 7

