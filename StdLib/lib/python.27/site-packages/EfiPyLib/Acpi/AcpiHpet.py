#
# AcpiHpet.py
#
# Copyright (C) 2018 efipy.core@gmail.com All rights reserved.
#
# AcpiHpet.py is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# AcpiHpet.py is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

import EfiPy
from EfiPyAcpiBase import AcpiTables
from EfiPy.MdePkg.IndustryStandard        import EFIPY_INDUSTRY_STRUCTURE
from EfiPy.MdePkg.IndustryStandard.Acpi10 import EFI_ACPI_DESCRIPTION_HEADER
from EfiPy.MdePkg.IndustryStandard.Acpi61 import EFI_ACPI_6_1_GENERIC_ADDRESS_STRUCTURE

HpetSize    = 0
HpetAddress = 0

for _Signature, _Address, _Length in AcpiTables:
  if _Signature == 'HPET':
    HpetAddress = _Address
    DescHeader = EFI_ACPI_DESCRIPTION_HEADER.from_address (HpetAddress)
    HpetSize    = _Length
    break;

if HpetAddress == 0:
  raise ImportError ('HPET Not found')

class HIGH_PRECISION_EVENT_TIMER_TABLE_STRUCTURE (EFIPY_INDUSTRY_STRUCTURE):
  _fields_ = [
    ("Header",                EFI_ACPI_DESCRIPTION_HEADER),
    ("EventTimerBlockID",     EfiPy.UINT32),
    ("BaseAddressLower32Bit", EFI_ACPI_6_1_GENERIC_ADDRESS_STRUCTURE),
    ("HpetNumber",            EfiPy.UINT8),
    ("Mode",                  EfiPy.UINT16),
    ("Attribute",             EfiPy.UINT8),
  ]

if HpetAddress != 0:
  DescHeader  = HIGH_PRECISION_EVENT_TIMER_TABLE_STRUCTURE.from_address (HpetAddress)
else:
  DescHeader  = None

Address   = HpetAddress
Table     = DescHeader
Size      = HpetSize
Revision  = DescHeader.Header.Revision
