#
# AcpiXsdt.py
#
# Copyright (C) 2018 efipy.core@gmail.com All rights reserved.
#
# AcpiXsdt.py is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# AcpiXsdt.py is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

import struct
import EfiPy
from EfiPy.MdePkg.IndustryStandard        import EFIPY_INDUSTRY_STRUCTURE
from EfiPy.MdePkg.IndustryStandard.Acpi10 import EFI_ACPI_DESCRIPTION_HEADER

Address   = 0
Table     = None
Size      = 0
Revision  = 0

def BuildXsdt (Rsdp):

  global Address
  global Table
  global Size
  global Revision

  _Xsdt = EFI_ACPI_DESCRIPTION_HEADER.from_address (Rsdp.XsdtAddress)
  class EXTENDED_SYSTEM_DESCRIPTION_TABLE (EFIPY_INDUSTRY_STRUCTURE):
    _fields_ = [
      ("Signature",         EfiPy.UINT32),
      ("Length",            EfiPy.UINT32),
      ("Revision",          EfiPy.UINT8),
      ("Checksum",          EfiPy.UINT8),
      ("OemId",             EfiPy.UINT8 * 6),
      ("OemTableId",        EfiPy.UINT64),
      ("OemRevision",       EfiPy.UINT32),
      ("CreatorId",         EfiPy.UINT32),
      ("CreatorRevision",   EfiPy.UINT32),
      ("DescriptionEntry",  EfiPy.UINT64 * ((_Xsdt.Length - EfiPy.sizeof (EFI_ACPI_DESCRIPTION_HEADER)) / EfiPy.sizeof (EfiPy.UINT64)))
    ]
  _Xsdt = EXTENDED_SYSTEM_DESCRIPTION_TABLE.from_address (Rsdp.XsdtAddress)

  Address   = Rsdp.XsdtAddress
  Table     = _Xsdt
  Size      = _Xsdt.Length
  Revision  = _Xsdt.Revision

  return _Xsdt