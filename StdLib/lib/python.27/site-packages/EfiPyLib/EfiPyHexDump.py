#!/usr/bin/python

#
# EfiPyHexDump.py
#
# Copyright (C) 2018 efipy.core@gmail.com All rights reserved.
#
# EfiPyHexDump.py is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 2 of the License.
#
# EfiPy is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with EfiPy.  If not, see <http://www.gnu.org/licenses/>.
#

HexDumpTable    = ["%02X" % x for x in xrange(256)]
AsciiDumpTable  = [  '%c' % x for x in xrange(256)]
HexPreHead      = [' '] * 16
HexPreHead[8]   = '  '
# HexPreHead[0]   = ''
AsciiPreHead    = [''] * 16
AsciiPreHead[8] = ' '

for x in AsciiDumpTable:
  if x < ' ' or x > '~':
    AsciiDumpTable[ord(x)] = "."

def EfiPyHexDump (PreSpace, offset, HexBuff, AsciiDump = True, title = None):

  Buffer = [-300] * (offset % 16)
  Buffer = Buffer + list(HexBuff)
  Buffer = Buffer + [-300] * ((16 - len(Buffer)) % 16)
  Start  = offset & 0xFFFFFFF0

  #
  # Print Header
  #
  # print
  if title is not None:
    print "== %s (Offset: 0x%08X, Lenght: 0x%04X) ==" % (title, offset, len(HexBuff))

  print " " * PreSpace + " Offset: 00 01 02 03 04 05 06 07  08 09 0A 0B 0C 0D 0E 0F",
  if AsciiDump == True:
    print ' *01234567 89ABCDEF*'
  else:
    print

  print " " * PreSpace + "-------- ------------------------------------------------",
  if AsciiDump == True:
    print ' -------------------'
  else:
    print

  DumpCount = 0
  DumpLine  = Start - 0x10
  DumpHex   = ""
  DumpChar  = ""
  for char in Buffer:

    # if type(char) is int:
    #   char = chr (char)

    if DumpCount == 0 and DumpChar != "":
      if AsciiDump == True:
        print " " * PreSpace + ('%08X' % DumpLine) + DumpHex + '  *' + DumpChar + '*'
      else:
        print " " * PreSpace + ('%08X' % DumpLine) + DumpHex
      DumpChar = ""
      DumpHex  = ""

    try:
      DumpHex   += HexPreHead[DumpCount] + HexDumpTable[ord(char)]
    except:
      DumpHex   += HexPreHead[DumpCount] + '  '
    try:
      DumpChar  += AsciiPreHead[DumpCount] + AsciiDumpTable[ord(char)]
    except:
      DumpChar  += AsciiPreHead[DumpCount] + ' '

    DumpCount  = (DumpCount + 1) % 16
    DumpLine  += 1
    
  if AsciiDump == True:
    print " " * PreSpace + ('%08X' % DumpLine) + DumpHex + '  *' + DumpChar + '*'
  else:
    print " " * PreSpace + ('%08X' % DumpLine) + DumpHex

if __name__ == '__main__':

  sample = '\x01\x00\x00\x00\x1e\x00E\x00F\x00I\x00 \x00D\x00V\x00D\x00/\x00C\x00D\x00R\x00O\x00M\x00\x00\x00\x02\x01\x0c\x00\xd0A\x03\n\x00\x00\x00\x00\x01\x01\x06\x00\x01\x01\x03\x01\x08\x00\x01\x00\x00\x00\x7f\xff\x04\x03'
  EfiPyHexDump (2, 0x00, sample, True, "Title Book")
  EfiPyHexDump (2, 0x03, sample, True, "Title Book")
  EfiPyHexDump (2, 0x03, sample, False, "Title Book")
